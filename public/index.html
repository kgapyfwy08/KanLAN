<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>åŠ è½½ä¸­...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* å…¨å±€æ ·å¼ */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f0f2f5;
      color: #333;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    /* å¡ç‰‡æ ·å¼ */
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }
    /* åœ¨çº¿çŠ¶æ€æ ·å¼ */
    .status-online {
      color: #28a745;
      font-weight: bold;
    }
    .status-offline {
      color: #6c757d;
    }
    /* ç½‘æ ¼å¸ƒå±€ */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin: 1rem 0 0;
    }
    .summary-stat {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }
    .summary-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: #007bff;
      display: block;
    }
    .summary-label {
      font-size: 0.85rem;
      color: #555;
    }
    /* å¾½ç« å’Œæ—¶é—´æ ·å¼ */
    .badge {
      background: #e9ecef;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.9em;
      display: inline-block;
    }
    .badge.warning {
      background: #fff3cd;
      color: #856404;
    }
    .badge.success {
      background: #d4edda;
      color: #155724;
    }
    .badge.route-badge {
      margin: 0 0.25rem 0.25rem 0;
    }
    .time {
      font-size: 0.9em;
      color: #666;
    }
    /* é”™è¯¯æ¶ˆæ¯ */
    #error-message {
      color: red;
      margin-bottom: 1rem;
    }
    /* å¤åˆ¶æŒ‰é’® */
    .copy-button {
      background: #007bff;
      border: none;
      color: #fff;
      padding: 4px 8px;
      margin-left: 8px;
      border-radius: 4px;
      font-size: 0.8em;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .copy-button:hover {
      background: #0056b3;
    }
    .action-button {
      background: #17a2b8;
      border: none;
      color: #fff;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .action-button:hover {
      background: #138496;
    }
    .action-button.success {
      background: #28a745;
    }
    .action-button.success:hover {
      background: #1e7e34;
    }
    .action-button.danger {
      background: #dc3545;
    }
    .action-button.danger:hover {
      background: #bd2130;
    }
    .controls-card {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }
    .controls .toggle {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.95rem;
      color: #555;
    }
    .search-input {
      padding: 0.6rem 0.8rem;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 0.95rem;
    }
    .summary-meta {
      display: grid;
      gap: 0.5rem;
    }
    .summary-section {
      margin-top: 0.75rem;
      font-size: 0.95rem;
      color: #444;
    }
    .member-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .empty-state {
      text-align: center;
      color: #666;
    }
    @media (max-width: 600px) {
      .summary-grid {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      }
    }
    /* emoji å¯¹é½ */
    .emoji {
      display: inline-block;
      width: 1.2em;
      text-align: center;
      margin-right: 0.5em;
    }
    /* Toast é€šçŸ¥æ ·å¼ */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      opacity: 0;
      transition: opacity 0.5s;
      pointer-events: none;
      z-index: 1000;
    }
    .toast.show {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="dashboard-title">KanLAN</h1>
    <div id="kanban-information">
      <div id="summary-card" class="card">æ­£åœ¨åŠ è½½ç½‘ç»œæ¦‚è§ˆ...</div>
      <div class="card controls-card">
        <div class="controls">
          <button id="refresh-button" class="action-button">åˆ·æ–°æˆå‘˜æ•°æ®</button>
          <label class="toggle">
            <input type="checkbox" id="toggle-unauthorized">
            <span>æ˜¾ç¤ºæœªæˆæƒæˆå‘˜</span>
          </label>
        </div>
        <input type="search" id="member-search" class="search-input" placeholder="æœç´¢åç§°ã€å¤‡æ³¨æˆ– Node ID">
      </div>
    </div>
    <div id="error-message"></div>
    <div class="grid" id="members-container"></div>
  </div>
  <!-- Toast æç¤ºå±‚ -->
  <div id="toast" class="toast"></div>

  <script>
    // ä» URL æŸ¥è¯¢å‚æ•°ä¸­è·å– net_id å’Œ token
    const params = new URLSearchParams(window.location.search);
    const netId = params.get('net_id');
    const token = params.get('token');

    if (!netId || !token) {
      window.location.href = 'setup.html';
    }

    // é»˜è®¤æ ‡é¢˜ä¸º netIdï¼Œå¾…è·å–ç½‘ç»œè¯¦æƒ…åæ›´æ–°
    document.title = `${netId} - KanLAN`;
    document.getElementById('dashboard-title').textContent = `${netId} KanLAN`;

    const errorContainer = document.getElementById('error-message');
    const summaryCard = document.getElementById('summary-card');
    const refreshButton = document.getElementById('refresh-button');
    const toggleUnauthorized = document.getElementById('toggle-unauthorized');
    const searchInput = document.getElementById('member-search');
    const membersContainer = document.getElementById('members-container');
    const MEMBER_CACHE_KEY = `ztDashboardCache_${netId}`;
    const CACHE_DURATION = 60000; // ç¼“å­˜æ—¶é•¿ï¼š1åˆ†é’Ÿ

    // ç½‘ç»œæ•°æ®æ°¸ä¹…ç¼“å­˜çš„ key
    const NETWORK_CACHE_KEY = `ztNetworkCache_${netId}`;
    const KANBAN_ADDRESS = window.location.href;

    let networkDetails = null;
    let membersState = [];
    let showUnauthorizedMembers = false;
    let searchKeyword = '';

    /**
     * æ˜¾ç¤º Toast æç¤ºï¼Œä¸æ‰“æ–­ç”¨æˆ·æ“ä½œ
     */
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    /**
     * å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
     * @param {string} text - è¦å¤åˆ¶çš„æ–‡æœ¬
     * @param {HTMLElement} button - å½“å‰ç‚¹å‡»çš„æŒ‰é’®ï¼ˆç”¨äºè§¦å‘æç¤ºï¼‰
     */
    function copyText(text, button) {
      navigator.clipboard.writeText(text).then(() => {
        showToast(`å·²å¤åˆ¶: ${text}`);
      }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥: ', err);
        showToast('å¤åˆ¶å¤±è´¥');
      });
    }

    /**
     * æ¸²æŸ“å•ä¸ªæˆå‘˜å¡ç‰‡
     */
    function renderMember(member) {
      const now = Date.now();
      const isOnline = (now - member.lastOnline) < 120000;
      const internalIP = (member.config.ipAssignments && member.config.ipAssignments.length)
                           ? member.config.ipAssignments[0]
                           : null;
      const isAuthorized = !!member.config.authorized;

      let ipHtml = '';
      if (internalIP) {
        ipHtml += `<div>
                    <span class="emoji">ğŸ </span> å†…ç½‘ IP: <span class="badge" id="internal-ip-${member.nodeId}">${internalIP}</span>
                    <button class="copy-button" onclick="copyText('${internalIP}', this)">å¤åˆ¶</button>
                  </div>`;
      }

      const externalIps = Array.isArray(member.config.ipAssignments) && member.config.ipAssignments.length > 1
        ? member.config.ipAssignments.slice(1).map(ip => `<span class="badge">${ip}</span>`).join(' ')
        : '';

      const routes = Array.isArray(member.routes) && member.routes.length
        ? `<div><span class="emoji">ğŸ›£ï¸</span> è·¯ç”±: ${member.routes.map(route => `<span class="badge route-badge">${route.target}${route.via ? ` â†’ ${route.via}` : ''}</span>`).join(' ')}</div>`
        : '';

      const authorizationBadge = isAuthorized
        ? '<span class="badge success">å·²æˆæƒ</span>'
        : '<span class="badge warning">æœªæˆæƒ</span>';

      const actions = [];
      if (isAuthorized) {
        actions.push(`<button class="action-button danger" data-action="toggle-authorization" data-member-id="${member.nodeId}" data-authorized="false">å–æ¶ˆæˆæƒ</button>`);
        actions.push(`<button class="action-button danger" data-action="remove-member" data-member-id="${member.nodeId}">ç§»é™¤æˆå‘˜</button>`);
      } else {
        actions.push(`<button class="action-button success" data-action="toggle-authorization" data-member-id="${member.nodeId}" data-authorized="true">æˆæƒæˆå‘˜</button>`);
        actions.push(`<button class="action-button danger" data-action="remove-member" data-member-id="${member.nodeId}">ç§»é™¤æˆå‘˜</button>`);
      }

      const hardwareInfo = member.deviceName || member.hardwareAddress
        ? `<div><span class="emoji">ğŸ’»</span> è®¾å¤‡ä¿¡æ¯: ${member.deviceName ? `<span class="badge">${member.deviceName}</span>` : ''} ${member.hardwareAddress ? `<span class="badge">${member.hardwareAddress}</span>` : ''}</div>`
        : '';

      return `
        <div class="card">
          <div style="margin-bottom: 1rem;">
            <h3 style="margin: 0;"><span class="emoji">ğŸ“Œ</span> ${member.name || 'æœªå‘½åè®¾å¤‡'}</h3>
            ${authorizationBadge}
          </div>
          <div style="display: grid; gap: 0.5rem;">
            ${member.description ? `<div><span class="emoji">ğŸ“</span> å¤‡æ³¨: <span class="badge">${member.description}</span></div>` : ''}
            <div>
              <span class="emoji">ğŸ†”</span> Node ID:
              <span class="badge" id="nodeid-${member.nodeId}">${member.nodeId}</span>
              <button class="copy-button" onclick="copyText('${member.nodeId}', this)">å¤åˆ¶</button>
            </div>
            <div><span class="emoji">ğŸ“±</span> å®¢æˆ·ç«¯: ${member.clientVersion} (åè®® v${member.protocolVersion})</div>
            <div>
              <span class="emoji">ğŸ•’</span> æœ€åæ´»åŠ¨:
              ${isOnline
                ? '<span class="status-online">ğŸŸ¢ åœ¨çº¿</span>'
                : `<span class="status-offline">ğŸ”´ ç¦»çº¿ ${new Date(member.lastOnline).toLocaleString()}</span>`
              }
            </div>
            ${ipHtml}
            ${externalIps ? `<div><span class="emoji">ğŸŒ</span> é¢å¤– IP: ${externalIps}</div>` : ''}
            ${hardwareInfo}
            ${member.physicalAddress ? `<div><span class="emoji">ğŸ”§</span> ç‰©ç†åœ°å€: <span class="badge">${member.physicalAddress}</span></div>` : ''}
            ${routes}
            <div><span class="emoji">ğŸ“¶</span> æœ€è¿‘ä¿¡å·è´¨é‡: <span class="badge">${member.recentLatency || 'æœªçŸ¥'}</span></div>
          </div>
          <div class="member-actions">${actions.join('')}</div>
        </div>
      `;
    }

    // ä» localStorage ä¸­è·å–ç¼“å­˜æ•°æ®ï¼ˆæˆå‘˜æ•°æ®ï¼Œ1 åˆ†é’Ÿå¤±æ•ˆï¼‰
    function getCachedData() {
      try {
        const cached = localStorage.getItem(MEMBER_CACHE_KEY);
        if (cached) {
          const parsed = JSON.parse(cached);
          if (Date.now() - parsed.timestamp < CACHE_DURATION) {
            return parsed.data;
          }
        }
      } catch (e) {
        console.error('è¯»å–ç¼“å­˜å¤±è´¥', e);
      }
      return null;
    }

    // ä¿å­˜æˆå‘˜æ•°æ®åˆ° localStorage ç¼“å­˜
    function setCachedData(data) {
      try {
        localStorage.setItem(MEMBER_CACHE_KEY, JSON.stringify({ timestamp: Date.now(), data }));
      } catch (e) {
        console.error('å†™å…¥ç¼“å­˜å¤±è´¥', e);
      }
    }

    // æ¸²æŸ“æ•°æ®åˆ°é¡µé¢ï¼ˆæˆå‘˜ä¿¡æ¯ï¼‰
    function renderData(data) {
      if (Array.isArray(data)) {
        membersState = data;
        renderMembers();
      } else if (data.error) {
        membersContainer.innerHTML = `<div class="card">é”™è¯¯: ${data.error}</div>`;
      } else {
        membersContainer.innerHTML = `<div class="card">æ•°æ®æ ¼å¼é”™è¯¯</div>`;
      }
      renderNetworkSummary();
    }

    /**
     * è·å–ç½‘ç»œè¯¦æƒ…æ•°æ®ï¼ˆç½‘ç»œåç§°ç­‰ï¼‰ï¼Œå¹¶æ°¸ä¹…ç¼“å­˜ï¼Œä¸é‡å¤è¯·æ±‚
     */
    async function fetchNetworkData() {
      // å…ˆå°è¯•è¯»å–ç¼“å­˜çš„ç½‘ç»œæ•°æ®
      const cachedNetworkData = localStorage.getItem(NETWORK_CACHE_KEY);
      if (cachedNetworkData) {
        try {
          const networkData = JSON.parse(cachedNetworkData);
          networkDetails = networkData;
          updateNetworkTitle(networkData);
          renderNetworkSummary();
          return;
        } catch (e) {
          console.error('è¯»å–ç¼“å­˜ç½‘ç»œæ•°æ®å¤±è´¥', e);
        }
      }
      // æ„é€ Network API åœ°å€
      const networkAPIPath = `/api/networks/${netId}?token=${encodeURIComponent(token)}`;
      try {
        // å‘èµ·è¯·æ±‚åˆ° ZeroTier ç”Ÿäº§ç¯å¢ƒ API
        const response = await fetch(networkAPIPath);
        if (!response.ok) {
          throw new Error(`HTTP é”™è¯¯: ${response.status}`);
        }
        const networkData = await response.json();
        networkDetails = networkData;
        // æ°¸ä¹…ç¼“å­˜ç½‘ç»œæ•°æ®ï¼ˆæ— è¿‡æœŸæ—¶é—´ï¼‰
        localStorage.setItem(NETWORK_CACHE_KEY, JSON.stringify(networkData));
        updateNetworkTitle(networkData);
        renderNetworkSummary();
      } catch (error) {
        console.error('è·å–ç½‘ç»œæ•°æ®å¤±è´¥:', error);
        errorContainer.textContent = `è·å–ç½‘ç»œæ•°æ®å¤±è´¥: ${error.message}`;
      }
    }

    /**
     * æ ¹æ®ç½‘ç»œæ•°æ®æ›´æ–°é¡µé¢æ ‡é¢˜
     * @param {Object} networkData - ç½‘ç»œè¯¦æƒ…æ•°æ®
     */
    function updateNetworkTitle(networkData) {
      if (networkData && networkData.config && networkData.config.name) {
        const networkName = networkData.config.name;
        document.title = `${networkName} - KanLAN`;
        document.getElementById('dashboard-title').textContent = `${networkName} KanLAN`;
      }
    }

    function renderNetworkSummary() {
      if (!summaryCard) return;

      const totalMembers = membersState.length;
      const authorizedMembers = membersState.filter(member => member.config.authorized).length;
      const unauthorizedMembers = totalMembers - authorizedMembers;
      const onlineMembers = membersState.filter(member => member.config.authorized && (Date.now() - member.lastOnline) < 120000).length;

      const networkName = networkDetails?.config?.name || netId;
      const networkType = networkDetails ? (networkDetails.config?.private === false ? 'å…¬æœ‰ç½‘ç»œ' : 'ç§æœ‰ç½‘ç»œ') : 'æœªçŸ¥';
      const assignmentPools = Array.isArray(networkDetails?.config?.ipAssignmentPools)
        ? networkDetails.config.ipAssignmentPools.map(pool => `${pool.ipRangeStart} - ${pool.ipRangeEnd}`)
        : [];
      const routes = Array.isArray(networkDetails?.routes)
        ? networkDetails.routes.map(route => `${route.target}${route.via ? ` â†’ ${route.via}` : ''}`)
        : [];
      const dnsServers = Array.isArray(networkDetails?.config?.dns?.servers)
        ? networkDetails.config.dns.servers
        : [];

      summaryCard.innerHTML = `
        <h2>${networkName} ç½‘ç»œæ¦‚è§ˆ</h2>
        <div class="summary-meta">
          <div><span class="emoji">ğŸ†”</span> ç½‘ç»œ ID: <span class="badge" id="network-id-badge">${netId}</span>
            <button class="copy-button" onclick="copyText('${netId}', this)">å¤åˆ¶</button>
          </div>
          <div><span class="emoji">ğŸ”—</span> Kanban åœ°å€: <span class="badge" id="kanban-address">${KANBAN_ADDRESS}</span>
            <button class="copy-button" onclick="copyText('${KANBAN_ADDRESS}', this)">å¤åˆ¶</button>
          </div>
          <div><span class="emoji">ğŸ”’</span> ç½‘ç»œç±»å‹: <span class="badge">${networkType}</span></div>
        </div>
        <div class="summary-grid">
          <div class="summary-stat">
            <span class="summary-value">${totalMembers}</span>
            <span class="summary-label">æˆå‘˜æ€»æ•°</span>
          </div>
          <div class="summary-stat">
            <span class="summary-value">${authorizedMembers}</span>
            <span class="summary-label">å·²æˆæƒæˆå‘˜</span>
          </div>
          <div class="summary-stat">
            <span class="summary-value">${onlineMembers}</span>
            <span class="summary-label">åœ¨çº¿æˆå‘˜</span>
          </div>
          <div class="summary-stat">
            <span class="summary-value">${unauthorizedMembers}</span>
            <span class="summary-label">å¾…æˆæƒæˆå‘˜</span>
          </div>
        </div>
        ${assignmentPools.length ? `<div class="summary-section"><span class="emoji">ğŸ“¡</span> åœ°å€æ± : ${assignmentPools.map(range => `<span class="badge">${range}</span>`).join(' ')}</div>` : ''}
        ${routes.length ? `<div class="summary-section"><span class="emoji">ğŸ›£ï¸</span> ç½‘ç»œè·¯ç”±: ${routes.map(route => `<span class="badge route-badge">${route}</span>`).join(' ')}</div>` : ''}
        ${dnsServers.length ? `<div class="summary-section"><span class="emoji">ğŸ§­</span> DNS: ${dnsServers.map(server => `<span class="badge">${server}</span>`).join(' ')}</div>` : ''}
      `;
    }

    function renderMembers() {
      if (!Array.isArray(membersState) || membersState.length === 0) {
        membersContainer.innerHTML = `<div class="card empty-state">æš‚æ—¶æ²¡æœ‰æˆå‘˜æ•°æ®ã€‚</div>`;
        return;
      }

      const filteredMembers = membersState
        .filter(member => (showUnauthorizedMembers || member.config.authorized))
        .filter(member => {
          if (!searchKeyword) return true;
          const keyword = searchKeyword.toLowerCase();
          const info = [member.name, member.description, member.nodeId, member.physicalAddress]
            .filter(Boolean)
            .join(' ')
            .toLowerCase();
          return info.includes(keyword);
        })
        .sort((a, b) => Number(b.lastOnline || 0) - Number(a.lastOnline || 0));

      if (filteredMembers.length === 0) {
        membersContainer.innerHTML = `<div class="card empty-state">æœªæ‰¾åˆ°åŒ¹é…çš„æˆå‘˜ã€‚</div>`;
        return;
      }

      membersContainer.innerHTML = filteredMembers.map(renderMember).join('');
    }

    // è·å–æˆå‘˜æ•°æ®
    async function fetchData(forceRefresh = false) {
      // ä¼˜å…ˆå°è¯•ä½¿ç”¨ç¼“å­˜ï¼ˆæˆå‘˜æ•°æ®ï¼‰
      const cachedData = !forceRefresh ? getCachedData() : null;
      if (cachedData) {
        console.log('ä½¿ç”¨ç¼“å­˜æ•°æ®');
        renderData(cachedData);
        return;
      }

      errorContainer.textContent = 'åŠ è½½æ•°æ®ä¸­...';

      // æ„é€ æˆå‘˜ API åœ°å€
      const memberAPIPath = `/api/networks/${netId}/members?token=${encodeURIComponent(token)}`;

      try {
        const response = await fetch(memberAPIPath);
        if (!response.ok) {
          throw new Error(`HTTP é”™è¯¯ï¼š${response.status}`);
        }
        const data = await response.json();
        console.log('è·å–æ•°æ®:', data);
        setCachedData(data);
        renderData(data);
        errorContainer.textContent = '';
      } catch (error) {
        console.error('è¯·æ±‚å¤±è´¥:', error);
        errorContainer.textContent = `è¯·æ±‚å¤±è´¥: ${error.message}`;
      }
    }

    async function updateMemberAuthorization(memberId, authorized, button) {
      button.disabled = true;
      button.textContent = authorized ? 'æˆæƒä¸­...' : 'å–æ¶ˆæˆæƒä¸­...';
      try {
        const response = await fetch(`/api/networks/${netId}/members/${memberId}?token=${encodeURIComponent(token)}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ config: { authorized } })
        });
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText || 'ZeroTier API å“åº”å¼‚å¸¸');
        }
        showToast(authorized ? 'æˆå‘˜å·²æˆæƒ' : 'å·²å–æ¶ˆæˆæƒ');
        localStorage.removeItem(MEMBER_CACHE_KEY);
        await fetchData(true);
      } catch (error) {
        console.error('æ›´æ–°æˆå‘˜æˆæƒå¤±è´¥:', error);
        showToast(`æ“ä½œå¤±è´¥: ${error.message}`);
      } finally {
        button.disabled = false;
        button.textContent = authorized ? 'æˆæƒæˆå‘˜' : 'å–æ¶ˆæˆæƒ';
      }
    }

    async function removeMember(memberId, button) {
      const confirmed = window.confirm('ç¡®å®šè¦ç§»é™¤æ­¤æˆå‘˜å—ï¼Ÿæ­¤æ“ä½œä¼šä»ç½‘ç»œä¸­åˆ é™¤è¯¥è®¾å¤‡ã€‚');
      if (!confirmed) {
        return;
      }

      button.disabled = true;
      button.textContent = 'ç§»é™¤ä¸­...';

      try {
        const response = await fetch(`/api/networks/${netId}/members/${memberId}?token=${encodeURIComponent(token)}`, {
          method: 'DELETE'
        });
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText || 'ZeroTier API å“åº”å¼‚å¸¸');
        }
        showToast('æˆå‘˜å·²ç§»é™¤');
        localStorage.removeItem(MEMBER_CACHE_KEY);
        await fetchData(true);
      } catch (error) {
        console.error('ç§»é™¤æˆå‘˜å¤±è´¥:', error);
        showToast(`ç§»é™¤å¤±è´¥: ${error.message}`);
      } finally {
        button.disabled = false;
        button.textContent = 'ç§»é™¤æˆå‘˜';
      }
    }

    membersContainer.addEventListener('click', (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;

      const action = target.getAttribute('data-action');
      if (!action) return;

      const memberId = target.getAttribute('data-member-id');
      if (!memberId) return;

      if (action === 'toggle-authorization') {
        const authorize = target.getAttribute('data-authorized') === 'true';
        updateMemberAuthorization(memberId, authorize, target);
      } else if (action === 'remove-member') {
        removeMember(memberId, target);
      }
    });

    refreshButton.addEventListener('click', () => {
      localStorage.removeItem(MEMBER_CACHE_KEY);
      fetchData(true);
    });

    toggleUnauthorized.addEventListener('change', (event) => {
      const target = event.target;
      if (!(target instanceof HTMLInputElement)) return;
      showUnauthorizedMembers = target.checked;
      renderMembers();
    });

    searchInput.addEventListener('input', (event) => {
      const target = event.target;
      if (!(target instanceof HTMLInputElement)) return;
      searchKeyword = target.value.trim();
      renderMembers();
    });

    // åˆå§‹åŠ è½½ï¼šå…ˆè·å–ç½‘ç»œè¯¦æƒ…ï¼ˆä»…ä¸€æ¬¡ï¼‰ï¼Œå†åŠ è½½æˆå‘˜æ•°æ®
    fetchNetworkData();
    fetchData();
    // æ¯ 1 åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡æˆå‘˜æ•°æ®ï¼ˆåŒæ—¶æ›´æ–°ç¼“å­˜ï¼‰
    setInterval(() => fetchData(true), CACHE_DURATION);
  </script>
</body>
</html>
