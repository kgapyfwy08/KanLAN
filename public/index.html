<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>åŠ è½½ä¸­...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f0f2f5;
      color: #333;
      margin: 0;
      padding: 2rem 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem 3rem;
    }
    .page-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .page-header h1 {
      margin: 0;
      font-size: 2.2rem;
    }
    .subtitle {
      margin: 0.25rem 0 0;
      color: #666;
    }
    .controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .button {
      background: #007bff;
      border: none;
      color: #fff;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.2s;
    }
    .button:hover {
      background: #0056b3;
      transform: translateY(-1px);
    }
    .button.secondary {
      background: #6c757d;
    }
    .button.secondary:hover {
      background: #565e64;
    }
    .button.danger {
      background: #dc3545;
    }
    .button.danger:hover {
      background: #a71d2a;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 35px rgba(15, 23, 42, 0.12);
    }
    .card-title {
      margin: 0 0 1rem;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .card-subtitle {
      color: #666;
      margin: 0 0 0.75rem;
      font-size: 0.95rem;
    }
    .card--pending {
      border: 1px solid rgba(255, 193, 7, 0.5);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1rem;
    }
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
    }
    .stat-card {
      background: #fff;
      border-radius: 12px;
      padding: 1rem 1.2rem;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
    }
    .stat-card h3 {
      margin: 0 0 0.25rem;
      font-size: 0.95rem;
      color: #6c757d;
    }
    .stat-card strong {
      font-size: 1.7rem;
      font-weight: 700;
    }
    .section {
      margin-top: 2rem;
    }
    .section-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .section-header h2 {
      margin: 0;
      font-size: 1.6rem;
    }
    .section-subtitle {
      color: #6c757d;
    }
    .status-online {
      color: #28a745;
      font-weight: 600;
    }
    .status-offline {
      color: #6c757d;
    }
    .badge {
      background: #e9ecef;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.9em;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: rgba(0, 123, 255, 0.12);
      color: #0056b3;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.85rem;
    }
    .info-grid {
      display: grid;
      gap: 0.5rem;
      font-size: 0.96rem;
    }
    .card-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 1.25rem;
    }
    #error-message {
      color: #dc3545;
      margin-bottom: 1rem;
      font-weight: 600;
    }
    .copy-button {
      background: #007bff;
      border: none;
      color: #fff;
      padding: 4px 8px;
      margin-left: 8px;
      border-radius: 4px;
      font-size: 0.8em;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .copy-button:hover {
      background: #0056b3;
    }
    .emoji {
      display: inline-block;
      width: 1.3em;
      text-align: center;
      margin-right: 0.5em;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      padding: 10px 20px;
      border-radius: 8px;
      opacity: 0;
      transition: opacity 0.5s;
      pointer-events: none;
      z-index: 1000;
    }
    .toast.show {
      opacity: 1;
    }
    @media (max-width: 640px) {
      body {
        padding: 1.5rem 0;
      }
      .container {
        padding: 0 1rem 2rem;
      }
      .page-header h1 {
        font-size: 1.8rem;
      }
      .controls {
        width: 100%;
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="page-header">
      <div>
        <h1 id="dashboard-title">KanLAN</h1>
        <p id="network-subtitle" class="subtitle"></p>
      </div>
      <div class="controls">
        <button class="button" id="refresh-button">ç«‹å³åˆ·æ–°</button>
      </div>
    </header>
    <div id="error-message"></div>
    <div id="kanban-information" class="card"></div>
    <section class="section">
      <div class="section-header">
        <h2>æˆå‘˜ç»Ÿè®¡</h2>
        <span id="last-updated" class="section-subtitle"></span>
      </div>
      <div id="member-stats" class="stat-grid"></div>
    </section>
    <section class="section">
      <div class="section-header">
        <h2>å·²æˆæƒæˆå‘˜</h2>
        <span id="authorized-count" class="section-subtitle"></span>
      </div>
      <div class="grid" id="authorized-members"></div>
    </section>
    <section class="section">
      <div class="section-header">
        <h2>å¾…æˆæƒæˆå‘˜</h2>
        <span id="pending-count" class="section-subtitle"></span>
      </div>
      <div class="grid" id="pending-members"></div>
    </section>
    <section class="section">
      <div class="section-header">
        <h2>ç½‘ç»œæ¦‚è§ˆ</h2>
      </div>
      <div id="network-overview" class="grid"></div>
    </section>
  </div>
  <!-- Toast æç¤ºå±‚ -->
  <div id="toast" class="toast"></div>

  <script>
    // ä» URL æŸ¥è¯¢å‚æ•°ä¸­è·å– net_id å’Œ token
    const params = new URLSearchParams(window.location.search);
    const netId = params.get('net_id');
    const token = params.get('token');

    if (!netId || !token) {
      window.location.href = 'setup.html';
    }

    // é»˜è®¤æ ‡é¢˜ä¸º netIdï¼Œå¾…è·å–ç½‘ç»œè¯¦æƒ…åæ›´æ–°
    document.title = `${netId} - KanLAN`;
    document.getElementById('dashboard-title').textContent = `${netId} KanLAN`;

    const errorContainer = document.getElementById('error-message');
    const kanbanInformationContainer = document.getElementById('kanban-information');
    const networkOverviewContainer = document.getElementById('network-overview');
    const memberStatsContainer = document.getElementById('member-stats');
    const authorizedMembersContainer = document.getElementById('authorized-members');
    const pendingMembersContainer = document.getElementById('pending-members');
    const authorizedCountLabel = document.getElementById('authorized-count');
    const pendingCountLabel = document.getElementById('pending-count');
    const networkSubtitle = document.getElementById('network-subtitle');
    const lastUpdatedLabel = document.getElementById('last-updated');
    const refreshButton = document.getElementById('refresh-button');
    const MEMBER_CACHE_KEY = `ztDashboardCache_${netId}`;
    const CACHE_DURATION = 60000; // ç¼“å­˜æ—¶é•¿ï¼š1åˆ†é’Ÿ

    // ç½‘ç»œæ•°æ®æ°¸ä¹…ç¼“å­˜çš„ key
    const NETWORK_CACHE_KEY = `ztNetworkCache_${netId}`;
    const KANBAN_SECURITY_NOTICE_KEY = 'ztKanbanSecurityNoticeShown';

    /**
     * æ˜¾ç¤º Toast æç¤ºï¼Œä¸æ‰“æ–­ç”¨æˆ·æ“ä½œ
     */
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    /**
     * å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
     * @param {string} text - è¦å¤åˆ¶çš„æ–‡æœ¬
     * @param {HTMLElement} button - å½“å‰ç‚¹å‡»çš„æŒ‰é’®ï¼ˆç”¨äºè§¦å‘æç¤ºï¼‰
     */
    function copyText(text, button) {
      return navigator.clipboard.writeText(text).then(() => {
        showToast(`å·²å¤åˆ¶: ${text}`);
      }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥: ', err);
        showToast('å¤åˆ¶å¤±è´¥');
      });
    }

    function showSecurityWarningOnce() {
      const message = 'âš ï¸ å®‰å…¨æç¤ºï¼šæ­¤é“¾æ¥åŒ…å«å¯ç›´æ¥è®¿é—®ç½‘ç»œçš„å¯†é’¥, è‹¥æ‚¨éœ€è¦åˆ†äº«ç»™ä»–äººè¯·1å¯¹1åˆ†äº«, è‹¥åœ¨å…¬å¼€åœºæ™¯åˆ†äº«å¯èƒ½å¯¼è‡´é™Œç”Ÿäººè¿›å…¥ç½‘ç»œ, å¯¹æ‚¨çš„ç½‘ç»œ/è®¾å¤‡/ä¸ªäººä¿¡æ¯ç­‰äº§ç”Ÿä¸¥é‡çš„å®‰å…¨å¨èƒã€‚';
      try {
        if (!localStorage.getItem(KANBAN_SECURITY_NOTICE_KEY)) {
          alert(message);
          localStorage.setItem(KANBAN_SECURITY_NOTICE_KEY, 'true');
        }
      } catch (error) {
        console.warn('æ— æ³•è®°å½•å®‰å…¨æç¤ºçŠ¶æ€:', error);
        alert(message);
      }
    }

    function copyKanbanAddress(address, button) {
      const copyResult = copyText(address, button);
      if (copyResult && typeof copyResult.finally === 'function') {
        copyResult.finally(showSecurityWarningOnce);
      } else {
        showSecurityWarningOnce();
      }
    }

    function renderKanbanAddress(address) {
      kanbanInformationContainer.innerHTML = '';

      const wrapper = document.createElement('div');
      const emoji = document.createElement('span');
      emoji.className = 'emoji';
      emoji.textContent = 'ğŸ”—';
      wrapper.appendChild(emoji);
      wrapper.append(' Kanban åœ°å€: ');

      const badge = document.createElement('span');
      badge.className = 'badge';
      badge.id = 'kanban-address';
      badge.textContent = address;
      wrapper.appendChild(badge);

      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'copy-button';
      button.textContent = 'å¤åˆ¶';
      button.addEventListener('click', () => copyKanbanAddress(address, button));
      wrapper.appendChild(button);

      kanbanInformationContainer.appendChild(wrapper);
    }

    /**
     * æ¸²æŸ“å•ä¸ªæˆå‘˜å¡ç‰‡
     * ä»…æ˜¾ç¤º authorized ä¸º true çš„æˆå‘˜
     */
    function renderMember(member, authorized = true) {
      const lastSeen = member.lastOnline || member.lastSeen || 0;
      const now = Date.now();
      const isOnline = lastSeen && (now - lastSeen) < 120000;
      const internalIP = (member.config.ipAssignments && member.config.ipAssignments.length)
                           ? member.config.ipAssignments[0]
                           : null;
      const physicalAddress = member.physicalAddress || member.clientVersion?.split('-')[0] || 'æœªçŸ¥åœ°å€';
      const authorizationTime = member.config.authorized ? member.config?.authorizedAt : member.requestTime;

      let ipHtml = '';
      if (internalIP) {
        ipHtml += `<div>
                    <span class="emoji">ğŸ </span> å†…ç½‘ IP: <span class="badge" id="internal-ip-${member.nodeId}">${internalIP}</span>
                    <button class="copy-button" onclick="copyText('${internalIP}', this)">å¤åˆ¶</button>
                  </div>`;
      }

      return `
        <div class="card ${authorized ? '' : 'card--pending'}">
          <div style="margin-bottom: 1rem;">
            <h3 style="margin: 0;"><span class="emoji">ğŸ“Œ</span> ${member.name || 'æœªå‘½åè®¾å¤‡'}</h3>
          </div>
          <div style="display: grid; gap: 0.5rem;">
            ${member.description ? `<div><span class="emoji">ğŸ“</span> å¤‡æ³¨: <span class="badge">${member.description}</span></div>` : ''}
            <div>
              <span class="emoji">ğŸ†”</span> Node ID:
              <span class="badge" id="nodeid-${member.nodeId}">${member.nodeId}</span>
              <button class="copy-button" onclick="copyText('${member.nodeId}', this)">å¤åˆ¶</button>
            </div>
            <div><span class="emoji">ğŸ“¡</span> å®ä½“åœ°å€: ${physicalAddress}</div>
            <div>
              <span class="emoji">ğŸ•’</span> æœ€åæ´»åŠ¨:
              ${isOnline
                ? '<span class="status-online">ğŸŸ¢ åœ¨çº¿</span>'
                : `<span class="status-offline">ğŸ”´ ç¦»çº¿ ${lastSeen ? new Date(lastSeen).toLocaleString() : 'æœªçŸ¥'}</span>`
              }
            </div>
            ${authorizationTime ? `<div><span class="emoji">â±ï¸</span> ${authorized ? 'æˆæƒæ—¶é—´' : 'è¯·æ±‚æ—¶é—´'}: ${new Date(authorizationTime).toLocaleString()}</div>` : ''}
            ${ipHtml}
          </div>
          <div class="card-actions">
            ${authorized
              ? `<button class="button secondary" onclick="unauthorizeMember('${member.nodeId}')">å–æ¶ˆæˆæƒ</button>`
              : `<button class="button" onclick="authorizeMember('${member.nodeId}')">ç«‹å³æˆæƒ</button>`
            }
            <button class="button danger" onclick="removeMember('${member.nodeId}')">ç§»é™¤æˆå‘˜</button>
          </div>
        </div>
      `;
    }

    // ä» localStorage ä¸­è·å–ç¼“å­˜æ•°æ®ï¼ˆæˆå‘˜æ•°æ®ï¼Œ1 åˆ†é’Ÿå¤±æ•ˆï¼‰
    function getCachedData() {
      try {
        const cached = localStorage.getItem(MEMBER_CACHE_KEY);
        if (cached) {
          const parsed = JSON.parse(cached);
          if (Date.now() - parsed.timestamp < CACHE_DURATION) {
            return parsed.data;
          }
        }
      } catch (e) {
        console.error('è¯»å–ç¼“å­˜å¤±è´¥', e);
      }
      return null;
    }

    // ä¿å­˜æˆå‘˜æ•°æ®åˆ° localStorage ç¼“å­˜
    function setCachedData(data) {
      try {
        localStorage.setItem(MEMBER_CACHE_KEY, JSON.stringify({ timestamp: Date.now(), data }));
      } catch (e) {
        console.error('å†™å…¥ç¼“å­˜å¤±è´¥', e);
      }
    }

    // æ¸²æŸ“æ•°æ®åˆ°é¡µé¢ï¼ˆæˆå‘˜ä¿¡æ¯ï¼‰
    function renderData(data) {
      if (Array.isArray(data)) {
        const authorizedMembers = data.filter(member => member.config.authorized);
        const pendingMembers = data.filter(member => !member.config.authorized);

        authorizedMembersContainer.innerHTML = authorizedMembers.length
          ? authorizedMembers.map(member => renderMember(member, true)).join('')
          : `<div class="card">æš‚æ— å·²æˆæƒæˆå‘˜ã€‚</div>`;

        pendingMembersContainer.innerHTML = pendingMembers.length
          ? pendingMembers.map(member => renderMember(member, false)).join('')
          : `<div class="card">æš‚æ— å¾…æˆæƒæˆå‘˜ã€‚</div>`;

        authorizedCountLabel.textContent = `å…± ${authorizedMembers.length} å°è®¾å¤‡ (${authorizedMembers.filter(isMemberOnline).length} åœ¨çº¿)`;
        pendingCountLabel.textContent = `å…± ${pendingMembers.length} å°å¾…å¤„ç†è®¾å¤‡`;
        renderMemberStats(authorizedMembers, pendingMembers);
      } else if (data.error) {
        authorizedMembersContainer.innerHTML = `<div class="card">é”™è¯¯: ${data.error}</div>`;
        pendingMembersContainer.innerHTML = '';
        authorizedCountLabel.textContent = '';
        pendingCountLabel.textContent = '';
      } else {
        authorizedMembersContainer.innerHTML = `<div class="card">æ•°æ®æ ¼å¼é”™è¯¯</div>`;
        pendingMembersContainer.innerHTML = '';
      }
    }

    function isMemberOnline(member) {
      const lastSeen = member.lastOnline || member.lastSeen || 0;
      return lastSeen && (Date.now() - lastSeen) < 120000;
    }

    function renderMemberStats(authorizedMembers, pendingMembers) {
      const onlineCount = authorizedMembers.filter(isMemberOnline).length;
      const offlineCount = authorizedMembers.length - onlineCount;
      const pendingCount = pendingMembers.length;
      const totalMembers = authorizedMembers.length + pendingCount;

      memberStatsContainer.innerHTML = `
        <div class="stat-card">
          <h3>å…¨éƒ¨æˆå‘˜</h3>
          <strong>${totalMembers}</strong>
        </div>
        <div class="stat-card">
          <h3>åœ¨çº¿è®¾å¤‡</h3>
          <strong style="color:#28a745;">${onlineCount}</strong>
        </div>
        <div class="stat-card">
          <h3>ç¦»çº¿è®¾å¤‡</h3>
          <strong>${offlineCount}</strong>
        </div>
        <div class="stat-card">
          <h3>å¾…æˆæƒè®¾å¤‡</h3>
          <strong style="color:#fd7e14;">${pendingCount}</strong>
        </div>
      `;
      lastUpdatedLabel.textContent = `æœ€è¿‘æ›´æ–°ï¼š${new Date().toLocaleString()}`;
    }

    /**
     * è·å–ç½‘ç»œè¯¦æƒ…æ•°æ®ï¼ˆç½‘ç»œåç§°ç­‰ï¼‰ï¼Œå¹¶æ°¸ä¹…ç¼“å­˜ï¼Œä¸é‡å¤è¯·æ±‚
     */
    async function fetchNetworkData() {
      // å…ˆå°è¯•è¯»å–ç¼“å­˜çš„ç½‘ç»œæ•°æ®
      const cachedNetworkData = localStorage.getItem(NETWORK_CACHE_KEY);
      if (cachedNetworkData) {
        try {
          const networkData = JSON.parse(cachedNetworkData);
          updateNetworkTitle(networkData);
          renderNetworkOverview(networkData);
          return;
        } catch (e) {
          console.error('è¯»å–ç¼“å­˜ç½‘ç»œæ•°æ®å¤±è´¥', e);
        }
      }
      // æ„é€ Network API åœ°å€
      const networkAPIPath = `/api?token=${encodeURIComponent(token)}&path=${encodeURIComponent('/network/' + netId)}`;
      try {
        // å‘èµ·è¯·æ±‚åˆ° ZeroTier ç”Ÿäº§ç¯å¢ƒ API
        const response = await fetch(networkAPIPath);
        if (!response.ok) {
          throw new Error(`HTTP é”™è¯¯: ${response.status}`);
        }
        const networkData = await response.json();
        // æ°¸ä¹…ç¼“å­˜ç½‘ç»œæ•°æ®ï¼ˆæ— è¿‡æœŸæ—¶é—´ï¼‰
        localStorage.setItem(NETWORK_CACHE_KEY, JSON.stringify(networkData));
        updateNetworkTitle(networkData);
        renderNetworkOverview(networkData);
      } catch (error) {
        console.error('è·å–ç½‘ç»œæ•°æ®å¤±è´¥:', error);
        errorContainer.textContent = `è·å–ç½‘ç»œæ•°æ®å¤±è´¥: ${error.message}`;
      }
    }

    /**
     * æ ¹æ®ç½‘ç»œæ•°æ®æ›´æ–°é¡µé¢æ ‡é¢˜
     * @param {Object} networkData - ç½‘ç»œè¯¦æƒ…æ•°æ®
     */
    function updateNetworkTitle(networkData) {
      if (networkData && networkData.config && networkData.config.name) {
        const networkName = networkData.config.name;
        document.title = `${networkName} - KanLAN`;
        document.getElementById('dashboard-title').textContent = `${networkName} KanLAN`;
        networkSubtitle.textContent = `ç½‘ç»œ ID: ${networkData.id || netId}`;
      } else {
        networkSubtitle.textContent = `ç½‘ç»œ ID: ${netId}`;
      }
    }

    function renderNetworkOverview(networkData) {
      if (!networkData || !networkData.config) {
        networkOverviewContainer.innerHTML = `<div class="card">æ— æ³•åŠ è½½ç½‘ç»œè¯¦æƒ…ã€‚</div>`;
        return;
      }

      const config = networkData.config;
      const description = config.description || 'æœªå¡«å†™æè¿°';
      const isPrivate = config.private !== false;
      const ipPools = Array.isArray(config.ipAssignmentPools) && config.ipAssignmentPools.length
        ? config.ipAssignmentPools.map(pool => {
            const start = pool.ipRangeStart || pool.start || 'æœªçŸ¥';
            const end = pool.ipRangeEnd || pool.end || 'æœªçŸ¥';
            return `${start} ~ ${end}`;
          }).join('<br>')
        : 'æœªé…ç½® IP åˆ†é…æ± ';
      const routes = Array.isArray(config.routes) && config.routes.length
        ? config.routes.map(route => {
            const target = route.target || route.destination || 'æœªçŸ¥ç›®æ ‡';
            const via = route.via || route.viaRouter || '';
            return `${target}${via ? ` â†’ ${via}` : ''}`;
          }).join('<br>')
        : 'æœªé…ç½®é™æ€è·¯ç”±';
      const mtu = config.mtu || 'é»˜è®¤';
      const multicastLimit = config.multicastLimit ?? 'é»˜è®¤';

      networkOverviewContainer.innerHTML = `
        <div class="card">
          <h3 class="card-title">ç½‘ç»œåŸºç¡€ä¿¡æ¯</h3>
          <div class="info-grid">
            <div><span class="emoji">ğŸ†”</span>ç½‘ç»œ ID: <span class="badge">${networkData.id || netId}</span></div>
            <div><span class="emoji">ğŸ·ï¸</span>ç½‘ç»œåç§°: <span class="badge">${config.name || 'æœªå‘½åç½‘ç»œ'}</span></div>
            <div><span class="emoji">ğŸ“</span>æè¿°: ${description}</div>
            <div><span class="emoji">ğŸ”’</span>æ¨¡å¼: <span class="tag">${isPrivate ? 'ç§æœ‰ç½‘ç»œ' : 'å…¬å¼€ç½‘ç»œ'}</span></div>
            <div><span class="emoji">ğŸ“¶</span>MTU: ${mtu}</div>
            <div><span class="emoji">ğŸ“¡</span>å¤šæ’­é™åˆ¶: ${multicastLimit}</div>
          </div>
        </div>
        <div class="card">
          <h3 class="card-title">åœ°å€ä¸è·¯ç”±</h3>
          <div class="info-grid">
            <div>
              <span class="emoji">ğŸ§­</span> IP åˆ†é…æ± :<br>
              <span class="badge">${ipPools}</span>
            </div>
            <div>
              <span class="emoji">ğŸ›£ï¸</span> é™æ€è·¯ç”±:<br>
              <span class="badge">${routes}</span>
            </div>
          </div>
        </div>
      `;
    }

    // è·å–æˆå‘˜æ•°æ®
    async function fetchData(forceRefresh = false) {
      // æ˜¾ç¤ºå½“å‰ KanLAN åœ°å€
      const kanbanAddress = window.location.href;
      renderKanbanAddress(kanbanAddress);

      // ä¼˜å…ˆå°è¯•ä½¿ç”¨ç¼“å­˜ï¼ˆæˆå‘˜æ•°æ®ï¼‰
      const cachedData = !forceRefresh ? getCachedData() : null;
      if (cachedData) {
        console.log('ä½¿ç”¨ç¼“å­˜æ•°æ®');
        renderData(cachedData);
        return;
      }

      errorContainer.textContent = 'åŠ è½½æ•°æ®ä¸­...';

      // æ„é€ æˆå‘˜ API åœ°å€
      const memberAPIPath = `/api?token=${encodeURIComponent(token)}&path=${encodeURIComponent('/network/' + netId + '/member')}`;

      try {
        const response = await fetch(memberAPIPath);
        if (!response.ok) {
          throw new Error(`HTTP é”™è¯¯ï¼š${response.status}`);
        }
        const data = await response.json();
        console.log('è·å–æ•°æ®:', data);
        setCachedData(data);
        renderData(data);
        errorContainer.textContent = '';
      } catch (error) {
        console.error('è¯·æ±‚å¤±è´¥:', error);
        errorContainer.textContent = `è¯·æ±‚å¤±è´¥: ${error.message}`;
      }
    }

    // åˆå§‹åŠ è½½ï¼šå…ˆè·å–ç½‘ç»œè¯¦æƒ…ï¼ˆä»…ä¸€æ¬¡ï¼‰ï¼Œå†åŠ è½½æˆå‘˜æ•°æ®
    fetchNetworkData();
    fetchData();
    // æ¯ 1 åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡æˆå‘˜æ•°æ®ï¼ˆåŒæ—¶æ›´æ–°ç¼“å­˜ï¼‰
    setInterval(fetchData, CACHE_DURATION);

    refreshButton.addEventListener('click', () => {
      localStorage.removeItem(MEMBER_CACHE_KEY);
      fetchData(true);
      showToast('æ­£åœ¨åˆ·æ–°æ•°æ®...');
    });

    async function authorizeMember(nodeId) {
      try {
        const res = await fetch(`/api?token=${encodeURIComponent(token)}&path=${encodeURIComponent('/network/' + netId + '/member/' + nodeId)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ config: { authorized: true } })
        });
        if (!res.ok) {
          const message = await res.text();
          throw new Error(message || `æˆæƒå¤±è´¥ (${res.status})`);
        }
        showToast('æˆå‘˜æˆæƒæˆåŠŸ');
        localStorage.removeItem(MEMBER_CACHE_KEY);
        fetchData(true);
      } catch (error) {
        console.error('æˆæƒå¤±è´¥:', error);
        showToast(`æˆæƒå¤±è´¥: ${error.message}`);
      }
    }

    async function unauthorizeMember(nodeId) {
      if (!confirm('ç¡®å®šè¦å–æ¶ˆè¯¥æˆå‘˜çš„æˆæƒå—ï¼Ÿ')) {
        return;
      }
      try {
        const res = await fetch(`/api?token=${encodeURIComponent(token)}&path=${encodeURIComponent('/network/' + netId + '/member/' + nodeId)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ config: { authorized: false } })
        });
        if (!res.ok) {
          const message = await res.text();
          throw new Error(message || `å–æ¶ˆæˆæƒå¤±è´¥ (${res.status})`);
        }
        showToast('å·²å–æ¶ˆæˆå‘˜æˆæƒ');
        localStorage.removeItem(MEMBER_CACHE_KEY);
        fetchData(true);
      } catch (error) {
        console.error('å–æ¶ˆæˆæƒå¤±è´¥:', error);
        showToast(`å–æ¶ˆæˆæƒå¤±è´¥: ${error.message}`);
      }
    }

    async function removeMember(nodeId) {
      if (!confirm('ç¡®å®šè¦ä»ç½‘ç»œä¸­ç§»é™¤è¯¥æˆå‘˜å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
        return;
      }
      try {
        const res = await fetch(`/api?token=${encodeURIComponent(token)}&path=${encodeURIComponent('/network/' + netId + '/member/' + nodeId)}`, {
          method: 'DELETE'
        });
        if (!res.ok) {
          const message = await res.text();
          throw new Error(message || `ç§»é™¤æˆå‘˜å¤±è´¥ (${res.status})`);
        }
        showToast('æˆå‘˜å·²ç§»é™¤');
        localStorage.removeItem(MEMBER_CACHE_KEY);
        fetchData(true);
      } catch (error) {
        console.error('ç§»é™¤æˆå‘˜å¤±è´¥:', error);
        showToast(`ç§»é™¤å¤±è´¥: ${error.message}`);
      }
    }

    window.authorizeMember = authorizeMember;
    window.unauthorizeMember = unauthorizeMember;
    window.removeMember = removeMember;
    window.copyText = copyText;
  </script>
</body>
</html>
