<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>åŠ è½½ä¸­...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* å…¨å±€æ ·å¼ */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f0f2f5;
      color: #333;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    /* å¡ç‰‡æ ·å¼ */
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }
    /* åœ¨çº¿çŠ¶æ€æ ·å¼ */
    .status-online {
      color: #28a745;
      font-weight: bold;
    }
    .status-offline {
      color: #6c757d;
    }
    /* ç½‘æ ¼å¸ƒå±€ */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
    }
    /* å¾½ç« å’Œæ—¶é—´æ ·å¼ */
    .badge {
      background: #e9ecef;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.9em;
    }
    .time {
      font-size: 0.9em;
      color: #666;
    }
    /* é”™è¯¯æ¶ˆæ¯ */
    #error-message {
      color: red;
      margin-bottom: 1rem;
    }
    /* å¤åˆ¶æŒ‰é’® */
    .copy-button {
      background: #007bff;
      border: none;
      color: #fff;
      padding: 4px 8px;
      margin-left: 8px;
      border-radius: 4px;
      font-size: 0.8em;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .copy-button:hover {
      background: #0056b3;
    }
    /* emoji å¯¹é½ */
    .emoji {
      display: inline-block;
      width: 1.2em;
      text-align: center;
      margin-right: 0.5em;
    }
    /* Toast é€šçŸ¥æ ·å¼ */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      opacity: 0;
      transition: opacity 0.5s;
      pointer-events: none;
      z-index: 1000;
    }
    .toast.show {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="dashboard-title">KanLAN</h1>
    <div id="kanban-information"></div>
    <div id="error-message"></div>
    <div class="grid" id="members-container"></div>
  </div>
  <!-- Toast æç¤ºå±‚ -->
  <div id="toast" class="toast"></div>

  <script>
    // ä» URL æŸ¥è¯¢å‚æ•°ä¸­è·å– net_id å’Œ token
    const params = new URLSearchParams(window.location.search);
    const netId = params.get('net_id');
    const token = params.get('token');

    if (!netId || !token) {
      window.location.href = 'setup.html';
    }

    // é»˜è®¤æ ‡é¢˜ä¸º netIdï¼Œå¾…è·å–ç½‘ç»œè¯¦æƒ…åæ›´æ–°
    document.title = `${netId} - KanLAN`;
    document.getElementById('dashboard-title').textContent = `${netId} KanLAN`;

    const errorContainer = document.getElementById('error-message');
    const kanbanInformationContainer = document.getElementById('kanban-information');
    const membersContainer = document.getElementById('members-container');
    const MEMBER_CACHE_KEY = `ztDashboardCache_${netId}`;
    const CACHE_DURATION = 60000; // ç¼“å­˜æ—¶é•¿ï¼š1åˆ†é’Ÿ

    // ç½‘ç»œæ•°æ®æ°¸ä¹…ç¼“å­˜çš„ key
    const NETWORK_CACHE_KEY = `ztNetworkCache_${netId}`;

    /**
     * æ˜¾ç¤º Toast æç¤ºï¼Œä¸æ‰“æ–­ç”¨æˆ·æ“ä½œ
     */
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    /**
     * å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
     * @param {string} text - è¦å¤åˆ¶çš„æ–‡æœ¬
     * @param {HTMLElement} button - å½“å‰ç‚¹å‡»çš„æŒ‰é’®ï¼ˆç”¨äºè§¦å‘æç¤ºï¼‰
     */
    function copyText(text, button) {
      navigator.clipboard.writeText(text).then(() => {
        showToast(`å·²å¤åˆ¶: ${text}`);
      }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥: ', err);
        showToast('å¤åˆ¶å¤±è´¥');
      });
    }

    /**
     * æ¸²æŸ“å•ä¸ªæˆå‘˜å¡ç‰‡
     * ä»…æ˜¾ç¤º authorized ä¸º true çš„æˆå‘˜
     */
    function renderMember(member) {
      const now = Date.now();
      const isOnline = (now - member.lastOnline) < 120000;
      const internalIP = (member.config.ipAssignments && member.config.ipAssignments.length)
                           ? member.config.ipAssignments[0]
                           : null;

      let ipHtml = '';
      if (internalIP) {
        ipHtml += `<div>
                    <span class="emoji">ğŸ </span> å†…ç½‘ IP: <span class="badge" id="internal-ip-${member.nodeId}">${internalIP}</span>
                    <button class="copy-button" onclick="copyText('${internalIP}', this)">å¤åˆ¶</button>
                  </div>`;
      }

      return `
        <div class="card">
          <div style="margin-bottom: 1rem;">
            <h3 style="margin: 0;"><span class="emoji">ğŸ“Œ</span> ${member.name || 'æœªå‘½åè®¾å¤‡'}</h3>
          </div>
          <div style="display: grid; gap: 0.5rem;">
            ${member.description ? `<div><span class="emoji">ğŸ“</span> å¤‡æ³¨: <span class="badge">${member.description}</span></div>` : ''}
            <div>
              <span class="emoji">ğŸ†”</span> Node ID:
              <span class="badge" id="nodeid-${member.nodeId}">${member.nodeId}</span>
              <button class="copy-button" onclick="copyText('${member.nodeId}', this)">å¤åˆ¶</button>
            </div>
            <div><span class="emoji">ğŸ“±</span> å®¢æˆ·ç«¯: ${member.clientVersion} (åè®® v${member.protocolVersion})</div>
            <div>
              <span class="emoji">ğŸ•’</span> æœ€åæ´»åŠ¨: 
              ${isOnline
                ? '<span class="status-online">ğŸŸ¢ åœ¨çº¿</span>'
                : `<span class="status-offline">ğŸ”´ ç¦»çº¿ ${new Date(member.lastOnline).toLocaleString()}</span>`
              }
            </div>
            ${ipHtml}
          </div>
        </div>
      `;
    }

    // ä» localStorage ä¸­è·å–ç¼“å­˜æ•°æ®ï¼ˆæˆå‘˜æ•°æ®ï¼Œ1 åˆ†é’Ÿå¤±æ•ˆï¼‰
    function getCachedData() {
      try {
        const cached = localStorage.getItem(MEMBER_CACHE_KEY);
        if (cached) {
          const parsed = JSON.parse(cached);
          if (Date.now() - parsed.timestamp < CACHE_DURATION) {
            return parsed.data;
          }
        }
      } catch (e) {
        console.error('è¯»å–ç¼“å­˜å¤±è´¥', e);
      }
      return null;
    }

    // ä¿å­˜æˆå‘˜æ•°æ®åˆ° localStorage ç¼“å­˜
    function setCachedData(data) {
      try {
        localStorage.setItem(MEMBER_CACHE_KEY, JSON.stringify({ timestamp: Date.now(), data }));
      } catch (e) {
        console.error('å†™å…¥ç¼“å­˜å¤±è´¥', e);
      }
    }

    // æ¸²æŸ“æ•°æ®åˆ°é¡µé¢ï¼ˆæˆå‘˜ä¿¡æ¯ï¼‰
    function renderData(data) {
      if (Array.isArray(data)) {
        // ä»…æ˜¾ç¤º authorized ä¸º true çš„æˆå‘˜
        const authorizedMembers = data.filter(member => member.config.authorized);
        if (authorizedMembers.length === 0) {
          membersContainer.innerHTML = `<div class="card">æ²¡æœ‰æˆæƒçš„æˆå‘˜ã€‚</div>`;
        } else {
          membersContainer.innerHTML = authorizedMembers.map(renderMember).join('');
        }
      } else if (data.error) {
        membersContainer.innerHTML = `<div class="card">é”™è¯¯: ${data.error}</div>`;
      } else {
        membersContainer.innerHTML = `<div class="card">æ•°æ®æ ¼å¼é”™è¯¯</div>`;
      }
    }

    /**
     * è·å–ç½‘ç»œè¯¦æƒ…æ•°æ®ï¼ˆç½‘ç»œåç§°ç­‰ï¼‰ï¼Œå¹¶æ°¸ä¹…ç¼“å­˜ï¼Œä¸é‡å¤è¯·æ±‚
     */
    async function fetchNetworkData() {
      // å…ˆå°è¯•è¯»å–ç¼“å­˜çš„ç½‘ç»œæ•°æ®
      const cachedNetworkData = localStorage.getItem(NETWORK_CACHE_KEY);
      if (cachedNetworkData) {
        try {
          const networkData = JSON.parse(cachedNetworkData);
          updateNetworkTitle(networkData);
          return;
        } catch (e) {
          console.error('è¯»å–ç¼“å­˜ç½‘ç»œæ•°æ®å¤±è´¥', e);
        }
      }
      // æ„é€ Network API åœ°å€
      const networkAPIPath = `/api?token=${encodeURIComponent(token)}&path=${encodeURIComponent('/network/' + netId)}`;
      try {
        // å‘èµ·è¯·æ±‚åˆ° ZeroTier ç”Ÿäº§ç¯å¢ƒ API
        const response = await fetch(networkAPIPath);
        if (!response.ok) {
          throw new Error(`HTTP é”™è¯¯: ${response.status}`);
        }
        const networkData = await response.json();
        // æ°¸ä¹…ç¼“å­˜ç½‘ç»œæ•°æ®ï¼ˆæ— è¿‡æœŸæ—¶é—´ï¼‰
        localStorage.setItem(NETWORK_CACHE_KEY, JSON.stringify(networkData));
        updateNetworkTitle(networkData);
      } catch (error) {
        console.error('è·å–ç½‘ç»œæ•°æ®å¤±è´¥:', error);
        errorContainer.textContent = `è·å–ç½‘ç»œæ•°æ®å¤±è´¥: ${error.message}`;
      }
    }

    /**
     * æ ¹æ®ç½‘ç»œæ•°æ®æ›´æ–°é¡µé¢æ ‡é¢˜
     * @param {Object} networkData - ç½‘ç»œè¯¦æƒ…æ•°æ®
     */
    function updateNetworkTitle(networkData) {
      if (networkData && networkData.config && networkData.config.name) {
        const networkName = networkData.config.name;
        document.title = `${networkName} - KanLAN`;
        document.getElementById('dashboard-title').textContent = `${networkName} KanLAN`;
      }
    }

    // è·å–æˆå‘˜æ•°æ®
    async function fetchData() {
      // æ˜¾ç¤ºå½“å‰ KanLAN åœ°å€
      const kanbanAddress = window.location.href;
      const kanbanHtml = `<div>
                             <span class="emoji">ğŸ”—</span> Kanban åœ°å€: 
                             <span class="badge" id="kanban-address">${kanbanAddress}</span>
                             <button class="copy-button" onclick="copyText('${kanbanAddress}', this)">å¤åˆ¶</button>
                           </div>`;
      kanbanInformationContainer.innerHTML = kanbanHtml;

      // ä¼˜å…ˆå°è¯•ä½¿ç”¨ç¼“å­˜ï¼ˆæˆå‘˜æ•°æ®ï¼‰
      const cachedData = getCachedData();
      if (cachedData) {
        console.log('ä½¿ç”¨ç¼“å­˜æ•°æ®');
        renderData(cachedData);
        return;
      }

      errorContainer.textContent = 'åŠ è½½æ•°æ®ä¸­...';

      // æ„é€ æˆå‘˜ API åœ°å€
      const memberAPIPath = `/api?token=${encodeURIComponent(token)}&path=${encodeURIComponent('/network/' + netId + '/member')}`;

      try {
        const response = await fetch(memberAPIPath);
        if (!response.ok) {
          throw new Error(`HTTP é”™è¯¯ï¼š${response.status}`);
        }
        const data = await response.json();
        console.log('è·å–æ•°æ®:', data);
        setCachedData(data);
        renderData(data);
        errorContainer.textContent = '';
      } catch (error) {
        console.error('è¯·æ±‚å¤±è´¥:', error);
        errorContainer.textContent = `è¯·æ±‚å¤±è´¥: ${error.message}`;
      }
    }

    // åˆå§‹åŠ è½½ï¼šå…ˆè·å–ç½‘ç»œè¯¦æƒ…ï¼ˆä»…ä¸€æ¬¡ï¼‰ï¼Œå†åŠ è½½æˆå‘˜æ•°æ®
    fetchNetworkData();
    fetchData();
    // æ¯ 1 åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡æˆå‘˜æ•°æ®ï¼ˆåŒæ—¶æ›´æ–°ç¼“å­˜ï¼‰
    setInterval(fetchData, CACHE_DURATION);
  </script>
</body>
</html>
